# .github/workflows/issue-driven-implementation.yml
name: ğŸ¤– Issue-Driven Implementation

on:
  issues:
    types: [labeled]

jobs:
  implement-from-issue:
    if: github.event.label.name == 'ready-to-implement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Parse Issue Details
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;
            
            // [F1] ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ©Ÿèƒ½IDã‚’æŠ½å‡º
            const featureIdMatch = title.match(/\[([F\d]+)\]/);
            const featureId = featureIdMatch ? featureIdMatch[1] : null;
            
            // æ©Ÿèƒ½åã‚’æŠ½å‡º
            const featureName = title.replace(/\[[^\]]+\]\s*/, '');
            
            console.log(`Feature ID: ${featureId}`);
            console.log(`Feature Name: ${featureName}`);
            
            core.setOutput('feature_id', featureId);
            core.setOutput('feature_name', featureName);
            core.setOutput('issue_number', issue.number);
            
            // Issueã®æœ¬æ–‡ã‹ã‚‰å®Ÿè£…è©³ç´°ã‚’æŠ½å‡º
            const body = issue.body || '';
            const typeMatch = body.match(/`([^`]+)`/);
            const featureType = typeMatch ? typeMatch[1] : 'feature';
            core.setOutput('feature_type', featureType);
      
      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              body: `ğŸ¤– è‡ªå‹•å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ï¼\n\nå®Ÿè£…å¯¾è±¡: **${{ steps.parse.outputs.feature_name }}** (ID: ${{ steps.parse.outputs.feature_id }})\n\né€²æ—ã¯ [Actions](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ã§ç¢ºèªã§ãã¾ã™ã€‚`
            });
      
      # iOSå®Ÿè£…
      - name: Generate iOS Implementation
        uses: NikoToRA/claude-code-action@main
        with:
          prompt: |
            voice-koereq iOS ã‚¢ãƒ—ãƒªã®å®Ÿè£…ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            æ©Ÿèƒ½: ${{ steps.parse.outputs.feature_name }} (${{ steps.parse.outputs.feature_id }})
            Issue: #${{ steps.parse.outputs.issue_number }}

            è¦ä»¶:
            - SwiftUI ã¨ Combine ã‚’ä½¿ç”¨
            - iOS 16+ å¯¾å¿œ
            - Azure Speech SDK ã‚’çµ±åˆ
            - æ—¥æœ¬èªUIã‚’å„ªå…ˆ
            - ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’å«ã‚€
            - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
            - MVVM ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

            ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
            1. Views/${{ steps.parse.outputs.feature_id }}View.swift
            2. ViewModels/${{ steps.parse.outputs.feature_id }}ViewModel.swift
            3. Services/${{ steps.parse.outputs.feature_id }}Service.swift

            å®Œå…¨ã«å‹•ä½œã™ã‚‹ production-ready ãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          output_path: ios/VoiceKoereq/
      
      # Androidå®Ÿè£…
      - name: Generate Android Implementation
        uses: NikoToRA/claude-code-action@main
        with:
          prompt: |
            voice-koereq Android ã‚¢ãƒ—ãƒªã®å®Ÿè£…ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            æ©Ÿèƒ½: ${{ steps.parse.outputs.feature_name }} (${{ steps.parse.outputs.feature_id }})
            Issue: #${{ steps.parse.outputs.issue_number }}

            è¦ä»¶:
            - Jetpack Compose ã¨ Kotlin
            - Material Design 3
            - Azure Speech SDK for Android
            - Coroutines ã¨ Flow
            - Hilt ã§ DI
            - æ—¥æœ¬èªUIã‚’å„ªå…ˆ

            ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
            1. ui/${{ steps.parse.outputs.feature_id }}Screen.kt
            2. viewmodel/${{ steps.parse.outputs.feature_id }}ViewModel.kt
            3. repository/${{ steps.parse.outputs.feature_id }}Repository.kt

            å®Œå…¨ã«å‹•ä½œã™ã‚‹ production-ready ãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          output_path: android/app/src/main/kotlin/com/voicekoereq/
      
      # å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯
      - name: Generate Shared Logic
        uses: NikoToRA/claude-code-action@main
        with:
          prompt: |
            voice-koereq ã® Kotlin Multiplatform å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            æ©Ÿèƒ½: ${{ steps.parse.outputs.feature_name }} (${{ steps.parse.outputs.feature_id }})

            è¦ä»¶:
            - expect/actual ãƒ‘ã‚¿ãƒ¼ãƒ³
            - Coroutines Flow
            - ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹

            ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
            1. ${{ steps.parse.outputs.feature_id }}/Repository.kt
            2. ${{ steps.parse.outputs.feature_id }}/Models.kt
            3. ${{ steps.parse.outputs.feature_id }}/UseCase.kt
          output_path: shared/src/commonMain/kotlin/com/voicekoereq/
      
      # ãƒ†ã‚¹ãƒˆç”Ÿæˆ
      - name: Generate Tests
        uses: NikoToRA/claude-code-action@main
        with:
          prompt: |
            ${{ steps.parse.outputs.feature_name }} ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            ã€iOSã€‘
            - XCTest ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
            - SwiftUI ã®UIãƒ†ã‚¹ãƒˆ
            
            ã€Androidã€‘
            - JUnit ãƒ†ã‚¹ãƒˆ
            - Compose UIãƒ†ã‚¹ãƒˆ
            - Mockito ãƒ¢ãƒƒã‚¯

            é«˜ã„ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç›®æŒ‡ã—ãŸãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          output_path: tests/
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "âœ¨ Implement ${{ steps.parse.outputs.feature_id }}: ${{ steps.parse.outputs.feature_name }}"
          title: "ğŸ¤– [${{ steps.parse.outputs.feature_id }}] ${{ steps.parse.outputs.feature_name }} - Auto Implementation"
          body: |
            ## ğŸ¤– è‡ªå‹•å®Ÿè£…
            
            ### ğŸ“‹ Issue
            Closes #${{ steps.parse.outputs.issue_number }}
            
            ### ğŸ¯ å®Ÿè£…æ©Ÿèƒ½
            - **æ©Ÿèƒ½å**: ${{ steps.parse.outputs.feature_name }}
            - **æ©Ÿèƒ½ID**: ${{ steps.parse.outputs.feature_id }}
            - **ã‚¿ã‚¤ãƒ—**: ${{ steps.parse.outputs.feature_type }}
            
            ### ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            
            #### iOS
            - [ ] `ios/VoiceKoereq/Views/${{ steps.parse.outputs.feature_id }}View.swift`
            - [ ] `ios/VoiceKoereq/ViewModels/${{ steps.parse.outputs.feature_id }}ViewModel.swift`
            - [ ] `ios/VoiceKoereq/Services/${{ steps.parse.outputs.feature_id }}Service.swift`
            
            #### Android
            - [ ] `android/.../ui/${{ steps.parse.outputs.feature_id }}Screen.kt`
            - [ ] `android/.../viewmodel/${{ steps.parse.outputs.feature_id }}ViewModel.kt`
            - [ ] `android/.../repository/${{ steps.parse.outputs.feature_id }}Repository.kt`
            
            #### å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯
            - [ ] `shared/.../Repository.kt`
            - [ ] `shared/.../Models.kt`
            - [ ] `shared/.../UseCase.kt`
            
            #### ãƒ†ã‚¹ãƒˆ
            - [ ] iOS ãƒ†ã‚¹ãƒˆ
            - [ ] Android ãƒ†ã‚¹ãƒˆ
            
            ### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            - æ—¥æœ¬èªå¯¾å¿œ
            
            ---
            *This PR was automatically generated by Claude AI*
          branch: implement/${{ steps.parse.outputs.feature_id }}-${{ github.run_number }}
          labels: |
            ${{ steps.parse.outputs.feature_type }}
            auto-implementation
            ${{ steps.parse.outputs.feature_id }}
      
      - name: Update Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              body: `âœ… å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nPR: #${{ steps.cpr.outputs.pull-request-number }}\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
            });
            
            // Issueã«å®Ÿè£…å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              labels: ['implemented']
            });